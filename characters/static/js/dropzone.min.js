(function($,k,l,m){"use strict";var o='dropzone',defaults={width:300,height:300,progressBarWidth:300,url:'',filesName:'files',margin:0,border:'2px dashed #ccc',background:'',zIndex:100,textColor:'#ccc',textAlign:'center',text:'Drop files here to upload',uploadMode:'single',progressContainer:'',src:'',dropzoneWraper:'nniicc-dropzoneParent',files:[],maxFileSize:'10MB',allowedFileTypes:'*',clickToUpload:true,showTimer:false,removeComplete:true,preview:false,uploadOnPreview:false,uploadOnDrop:true,params:{},load:null,progress:null,uploadDone:null,success:null,error:null,previewDone:null,};function Plugin(a,b){this.element=a;this.options=$.extend({},defaults,b);this._defaults=defaults;this._name=o;this.init()}var p={};var q={};var r={};var s=0;Plugin.prototype.init=function(){$(this.element).css({width:this.options.width,height:this.options.height,border:this.options.border,background:this.options.background,color:this.options.textColor,'text-align':this.options.textAlign,'box-align':'center','box-pack':'center','z-index':this.options.zIndex});$(this.element).hover(function(){$(this).css("cursor","pointer")},function(){$(this).css("cursor","default")});$(this.element).html(this.options.text);$(this.element).wrap('<div class="'+this.options.dropzoneWraper+'"></div>');$("."+this.options.dropzoneWraper).css('margin',this.options.margin);if(this.options.progressContainer===''){this.options.progressContainer="."+this.options.dropzoneWraper}if(this.options.src)$(this.element).attr('src',this.options.src);if(typeof $(this.element).attr('src')!=='undefined'){var f=$(this.element).attr('src');$(this.element).attr('src','');var g=$(this.element).clone();$(this.element).css({'z-index':this.options.zIndex,position:'absolute'}).html('').parent().css('position','relative');g.appendTo($(this.element).parent());g.replaceWith('<img class="previewImg" src="'+f+'" />');$(this.element).parent().find(".previewImg").css({width:this.options.width,height:this.options.height,border:this.options.border,background:this.options.background,color:this.options.textColor,'text-align':this.options.textAlign,'box-align':'center','box-pack':'center'})}if(this.options.clickToUpload){$(this.element).parent().append('<form></form>');var h=this.options.preview;var i="";if(!h)i="multiple";$(this.element).parent().find('form').append('<input type="file" name="'+this.options.filesName+'" '+i+'/>').hide().bind('change',function(a){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(this,a.target[0].files);var b=$(this.element).parent().find('input');b.unwrap().hide()}.bind(this))}$(this.element).bind({dragover:function(e){e.preventDefault();e.stopPropagation();$(this.element).css({color:'#000','border-color':'#000'})}.bind(this),dragleave:function(e){e.preventDefault();e.stopPropagation();dragLeave(this)}.bind(this),drop:function(e){e.preventDefault();dragLeave(this);if(!this.options.preview){upload(this,e.originalEvent.dataTransfer.files)}else{upload(this,e.originalEvent.dataTransfer.files)}}.bind(this),click:function(e){if(this.options.clickToUpload){var c;var d;c=$(this.element).parent().find('input');if(c.parent().prop('tagName')!=='FORM'){d=$("<form></form>");d.bind('change',function(){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(this,a.target[0].files);var b=$(this.element).parent().find('input');b.unwrap().hide()}.bind(this));c.wrap(d)}c.trigger('click')}}.bind(this)});if(typeof this.options.load=="function")this.options.load(this)};function dragLeave(a){var b=a.options.textColor;var c=a.options.border.split(" ");if(c.length==3)b=c[2];$(a.element).css({color:a.options.textColor,'border-color':b})}function upload(c,d){if(c.options.preview){if(!checkFileType(c,d[0])){if(typeof c.options.error=="function"){c.options.error($(c.element),"fileNotAllowed","File is not allowerd to upload! You can only upload the following files ("+c.options.allowedFileTypes+")")}else alert("File is not allowerd to upload! You can only upload the following files ("+c.options.allowedFileTypes+")");return}if(!checkFileSize(c,d[0])){if(typeof c.options.error=="function"){c.options.error($(c.element),"fileToBig",'File to big ('+formatBytes(d[0].size)+')! Max file size is ('+c.options.maxFileSize+')')}else alert('File to big ('+formatBytes(d[0].size)+')! Max file size is ('+c.options.maxFileSize+')');return}var f=new FileReader();$(c.element).parent().find('img').remove();$(c.element).css({'z-index':c.options.zIndex,position:'absolute'}).html('').parent().css('position','relative');var g=$(c.element).clone();g.appendTo($(c.element).parent());g.replaceWith('<img class="previewImg" />');$(c.element).parent().find(".previewImg").css({width:c.options.width,height:c.options.height,border:c.options.border,background:c.options.background,color:c.options.textColor,'text-align':c.options.textAlign,'box-align':'center','box-pack':'center'});f.onload=function(e){$(this.element).parent().find('img').attr('src',e.target.result).show();if(typeof this.options.previewDone=="function")this.options.previewDone($(this.element))}.bind(c);f.readAsDataURL(d[0])}var h;if(d){c.options.files=d;if(c.options.removeComplete){var j=$(".progress-bar:not(.active)").parents('.extra-progress-wrapper');j.each(function(a,b){b.remove()})}var i,formData,xhr;if(c.options.uploadMode=='all'){r[0]=$.now();formData=new FormData();xhr=new XMLHttpRequest();for(i=0;i<d.length;i++){formData.append(c.options.filesName+'[]',d[i])}if(Object.keys(c.options.params).length>0){for(h in c.options.params){formData.append(h,c.options.params[h])}}addProgressBar(c,0);bindXHR(c,xhr,0);xhr.open('post',c.options.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show()}else if(c.options.uploadMode=='single'){for(i=0;i<d.length;i++){r[s]=$.now();formData=new FormData();xhr=new XMLHttpRequest();if(!checkFileType(c,d[i])){addWrongFileField(c,i,s);s++;continue}if(!checkFileSize(c,d[i])){addFileToBigField(c,i,s);s++;continue}formData.append(c.options.filesName+'[]',d[i]);if(Object.keys(c.options.params).length>0){for(h in c.options.params){formData.append(h,c.options.params[h])}}if((!c.options.preview&&c.options.uploadOnDrop)||(c.options.preview&&c.options.uploadOnPreview)){addProgressBar(c,i,s);bindXHR(c,xhr,i,s);xhr.open('post',c.options.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show();s++}}}}}function startTimer(i){q[i]=k.setInterval(function(){var a=$(".upload-timer-"+i);var b=$.now()-r[i];var c=b/1000;var d=0;if(c>=60){d=Math.round(c/60);c=c%60}a.text(d+":"+pad(c.toFixed(2),5))},10)}function pad(a,b){a=a.toString();return a.length<b?pad("0"+a,b):a}function bindXHR(d,f,i,g){$(f.upload).bind({progress:function(e){if(e.originalEvent.lengthComputable){var a=e.originalEvent.loaded/e.originalEvent.total*100;if(typeof d.options.progress=="function")d.options.progress(a,g);else{$(".progress-"+g).children().css("width",a+"%").html(a.toFixed(0)+"%")}}},loadstart:function(e,a,b,c){startTimer(g)}});p[g]=false;$(f).bind({readystatechange:function(){if(this.readyState==4&&this.status==200){changeXhrDoneStatus(g);$(".progress.progress-"+g).children().removeClass('active');if(typeof d.options.success=="function")d.options.success(this,g)}}});var h=setInterval(function(){if(Object.keys(p).length>0){var a={};for(var b in p){if(p[b]===true)a[b]=true}if(Object.keys(p).length==Object.keys(a).length){clearInterval(h);p={};if(typeof d.options.uploadDone=="function")d.options.uploadDone($(d.element))}}},500)}function changeXhrDoneStatus(i){p[i]=true;clearInterval(q[i])}function addProgressBar(a,i,b){$(a.element).parent().append('<div class="progress progress-'+b+'"></div>').css({'margin':a.options.margin});$(".progress-"+b).css({width:a.options.progressBarWidth,margin:'20px 0 0 0',}).append('<div class="progress-bar active"></div>').hide();$(".progress-"+b).wrap('<div class="extra-progress-wrapper"></div>');if(a.options.showTimer){$(".progress-"+b).parent().append('<span style="float:right" class="upload-timer-'+b+'">0</span>')}}function addFileToBigField(a,i,b){$(a.element).parent().append('<div class="progress error-progress-'+b+'"></div>').css('margin',a.options.margin);var c=a.options.files[i];var d=c.name.trunc(25);$(".error-progress-"+b).css({width:a.options.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File to big ('+formatBytes(c.size)+')</div>');$(".error-progress-"+b).wrap('<div class="extra-progress-wrapper"></div>').css("width",a.options.progressBarWidth);$(".error-progress-"+b).parent().append('<span title="'+a.options.files[i].name+'">'+d+'</span>')}function addWrongFileField(a,i,b){$(a.element).parent().append('<div class="progress error-progress-'+b+'"></div>').css('margin',a.options.margin);var c=a.options.files[i];var d=c.name.trunc(25);var e=c.name.substr(c.name.lastIndexOf('.')+1);$(".error-progress-"+b).css({width:a.options.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File type ('+e+') is not allowed</div>');$(".error-progress-"+b).wrap('<div class="extra-progress-wrapper"></div>').css("width",a.options.progressBarWidth);$(".error-progress-"+b).parent().append('<span title="'+a.options.files[i].name+'">'+d+'</span>')}function showTooltip(){$("span").tooltip({open:function(a,b){b.tooltip.css("max-width",'100%')}})}function checkFileType(a,b){if(!b.type&&b.size%4096===0)return false;if(a.options.allowedFileTypes=='*')return true;var c=b.name.substr(b.name.lastIndexOf('.')+1).toLowerCase();var d=a.options.allowedFileTypes.replace(' ','').split(",");var e=[];for(var i=d.length-1;i>=0;i--){if(d[i].indexOf(".")!=-1){if(b.type.match(d[i])!==null)return true}e.push(d[i].toLowerCase())}if($.inArray(c,e)!=-1)return true;return false}function checkFileSize(a,b){var c=['Bytes','KB','MB','GB','TB'];var d=a.options.maxFileSize.match(/[a-zA-Z]+/g)[0];var e=a.options.maxFileSize.match(/\d+/)[0];var f=$.inArray(d,c);if(f!=-1){var g=formatBytes(b.size);var h=g.match(/[a-zA-Z]+/g)[0];var i=g.match(/\d+/)[0];var j;if(d==h){j=$.inArray(h,c);if(parseInt(i)*(Math.pow(1024,j))>b.size){return true}}else{j=$.inArray(h,c);if(j>-1){if((parseInt(i)*(Math.pow(1024,j)))<(parseInt(e)*(Math.pow(1024,f)))){return true}}}}else{alert("Incorect max file size definition!! ("+c.join(',')+")")}return false}function formatBytes(a,b){var c=['Bytes','KB','MB','GB','TB'];if(a===0)return'0 Byte';var i=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,i),2)+c[i]}String.prototype.trunc=String.prototype.trunc||function(n){return this.length>n?this.substr(0,n-1)+'&hellip;':this};$.fn[o]=function(a){return this.each(function(){if(!$.data(this,'plugin_'+o)){$.data(this,'plugin_'+o,new Plugin(this,a))}})}})(jQuery,window,document);
